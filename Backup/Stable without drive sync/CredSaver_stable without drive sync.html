<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CredSaver_Web</title>

  <!-- React + Babel + Tailwind -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
  /************** Crypto helpers **************/
  async function deriveKeyFromPassword(password, salt, iterations = 190000) {
    const enc = new TextEncoder();
    const pwKey = await crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt, iterations, hash: "SHA-256" },
      pwKey,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt","decrypt"]
    );
  }
  function randomBytes(len){ return crypto.getRandomValues(new Uint8Array(len)); }
  async function encryptJSONWithPassword(obj, password) {
    const salt=randomBytes(16), iv=randomBytes(12);
    const key=await deriveKeyFromPassword(password,salt);
    const plaintext=new TextEncoder().encode(JSON.stringify(obj));
    const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,plaintext);
    return {version:1, iterations:190000, salt:Array.from(salt), iv:Array.from(iv), blob:Array.from(new Uint8Array(ct)), createdAt:new Date().toISOString()};
  }
  async function decryptBlobWithPassword(storedBlob,password){
    const salt=new Uint8Array(storedBlob.salt), iv=new Uint8Array(storedBlob.iv), ct=new Uint8Array(storedBlob.blob);
    const key=await deriveKeyFromPassword(password,salt,storedBlob.iterations||190000);
    try{const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct); return JSON.parse(new TextDecoder().decode(pt));}
    catch(e){throw new Error("Decryption failed.");}
  }

  /************** Storage **************/
  const DB_KEY="vault_database";
  function saveDatabase(obj){localStorage.setItem(DB_KEY,JSON.stringify(obj));}
  function loadDatabase(){const r=localStorage.getItem(DB_KEY);return r?JSON.parse(r):null;}
  function removeDatabase(){localStorage.removeItem(DB_KEY);}
  function uid(){return Math.random().toString(36).slice(2,10);}

  /************** Clipboard **************/
  async function copyToClipboard(text,onClear){
    try{await navigator.clipboard.writeText(text);
      if(onClear)setTimeout(onClear,30000);
      return true;
    }catch{return false;}
  }

  /************** App **************/
  function App(){
    const [status,setStatus]=React.useState("idle");
    const [master,setMaster]=React.useState("");
    const [database,setDatabase]=React.useState([]);
    const [dbMeta,setDbMeta]=React.useState(null);
    const [search,setSearch]=React.useState("");
    const [editing,setEditing]=React.useState(null);
    const [revealMap,setRevealMap]=React.useState({});
    const [copiedMsg,setCopiedMsg]=React.useState("");

    React.useEffect(()=>{const db=loadDatabase(); if(db){setStatus("locked");setDbMeta(db);} else{setStatus("idle");}},[]);

    async function unlock(e){
      e&&e.preventDefault(); if(!master)return alert("Enter master password.");
      const stored=loadDatabase();
      if(!stored){
        const newDb=await encryptJSONWithPassword([],master); saveDatabase(newDb); setDbMeta(newDb); setDatabase([]); setStatus("unlocked"); return;
      }
      try{const dec=await decryptBlobWithPassword(stored,master); setDatabase(dec); setStatus("unlocked");}
      catch{alert("Unlock failed");}
    }

    function lock(){setMaster("");setDatabase([]);setStatus("locked");}

    async function persistDatabase(newData){
      const db=newData!==undefined?newData:database;
      const newDb=await encryptJSONWithPassword(db,master);
      saveDatabase(newDb); setDbMeta(newDb);
    }

    /** CRUD with auto-save **/
    function startAdd(){setEditing({id:uid(),site:"",username:"",password:"",notes:""});}
    function startEdit(r){setEditing({...r});}
    async function finishEdit(save){
      if(!editing)return;
      if(save){
        if(!editing.site) return alert("Site required");
        setDatabase(prev=>{
          const i=prev.findIndex(x=>x.id===editing.id);
          const updated=i>=0?(prev.map(p=>p.id===editing.id?editing:p)):[...prev,editing];
          persistDatabase(updated); return updated;
        });
      }
      setEditing(null);
    }
    async function removeRecord(id){
      if(!confirm("Delete this record?"))return;
      setDatabase(prev=>{
        const updated=prev.filter(r=>r.id!==id);
        persistDatabase(updated); return updated;
      });
    }

    const filtered=database.filter(r=>{
      const q=search.toLowerCase(); if(!q)return true;
      return (r.site||"").toLowerCase().includes(q)||(r.username||"").toLowerCase().includes(q)||(r.notes||"").toLowerCase().includes(q);
    });

    function toggleReveal(id){setRevealMap(p=>({...p,[id]:!p[id]}));}
    function handleCopyPassword(p){
      copyToClipboard(p,()=>{setCopiedMsg("Clipboard cleared"); setTimeout(()=>setCopiedMsg(""),2000);})
      .then(ok=>{setCopiedMsg(ok?"Copied (auto-clear 30s)":"Copy failed"); setTimeout(()=>setCopiedMsg(""),3000);});
    }

    async function resetDatabase(){
      const pw=prompt("Enter master password to confirm reset:");
      if(pw!==master){alert("Wrong password. Reset cancelled.");return;}
      if(confirm("This will permanently delete your encrypted database. Continue?")){
        removeDatabase(); setDatabase([]); setDbMeta(null); setStatus("idle"); alert("Database cleared.");
      }
    }

    function exportDatabase() {
      const stored = loadDatabase();
      if (!stored) return alert("No database to export.");
      const blob = new Blob([JSON.stringify(stored, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "secure_vault_export.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    async function resetMasterPassword() {
      const newPw = prompt("Enter NEW master password:");
      if (!newPw) return;
      const confirmPw = prompt("Re-enter NEW master password:");
      if (newPw !== confirmPw) {
        alert("Passwords do not match."); return;
      }
      try {
        const newDb = await encryptJSONWithPassword(database, newPw);
        saveDatabase(newDb);
        setDbMeta(newDb);
        setMaster(newPw);
        alert("Master password changed successfully.");
      } catch (e) {
        alert("Failed to reset master password: " + e.message);
      }
    }

    async function importDatabase(ev) {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function() {
        try {
          const parsed = JSON.parse(reader.result);
          if (!parsed.blob || !parsed.salt) {
            alert("Invalid database file."); return;
          }
          const importPw = prompt("Enter master password for the imported database:");
          if (!importPw) return;

          const importedData = await decryptBlobWithPassword(parsed, importPw);

          // Deduplicate and merge
          const current = [...database];
          let added = 0, skipped = 0;
          importedData.forEach(entry => {
            const exists = current.some(
              r => (r.site||"").toLowerCase() === (entry.site||"").toLowerCase() &&
                   (r.username||"").toLowerCase() === (entry.username||"").toLowerCase()
            );
            if (exists) skipped++;
            else { current.push(entry); added++; }
          });

          setDatabase(current);
          await persistDatabase(current);

          alert(`Imported ${added} new entries. Skipped ${skipped} duplicates.`);
        } catch (e) {
          alert("Failed to import/merge: " + e.message);
        }
      };
      reader.readAsText(file);
      ev.target.value = "";
    }

    /************** UI **************/
    if(status==="idle"||status==="locked"){
      return(
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="w-full max-w-md bg-gray-800 rounded-2xl shadow p-6">
            <h1 className="text-2xl font-semibold mb-2 text-white">CredSaver_Web</h1> 
            <p className="text-sm text-gray-400 mb-4">Dark-mode, client-side encryption.</p>
            <form onSubmit={unlock} className="space-y-3">
              <input type="password" value={master} onChange={e=>setMaster(e.target.value)} placeholder="Master password"
                className="w-full bg-gray-700 border border-gray-600 text-gray-100 rounded p-2"/>
              <button type="submit" className="w-full px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded">Unlock / Create</button>
            </form>
          </div>
        </div>
      );
    }

    return(
      <div className="min-h-screen p-6 bg-gray-900 text-gray-100">
        <div className="max-w-5xl mx-auto mb-4">
          {/* Row 1: Heading + Search */}
          <div className="flex justify-between items-center mb-3">
            <h1 className="text-2xl font-semibold">CredSaver_Web</h1>
            <input
              className="bg-gray-700 border border-gray-600 text-gray-100 rounded p-2 w-64"
              placeholder="Search..."
              value={search}
              onChange={e=>setSearch(e.target.value)}
            />
          </div>

          {/* Row 2: Action buttons */}
          <div className="flex flex-wrap gap-2">
            <button onClick={startAdd} className="px-3 py-2 bg-green-600 hover:bg-green-500 rounded flex items-center gap-2">➕ Add</button>
            <button onClick={exportDatabase} className="px-3 py-2 bg-gray-700 rounded flex items-center gap-2">📤 Export</button>
            <button onClick={() => document.getElementById('importDb').click()} className="px-3 py-2 bg-gray-700 rounded flex items-center gap-2">📥 Import DB</button>
            <input id="importDb" type="file" accept=".json" onChange={importDatabase} className="hidden" />
            <button onClick={resetMasterPassword} className="px-3 py-2 bg-amber-600 hover:bg-amber-500 rounded flex items-center gap-2">🔑 Reset Master</button>
            <button onClick={resetDatabase} className="px-3 py-2 bg-red-600 hover:bg-red-500 rounded flex items-center gap-2">🗑 Delete DB</button>
            <button onClick={lock} className="ml-auto flex items-center gap-2 px-3 py-2 border border-gray-500 text-gray-300 rounded hover:bg-red-700/20 hover:text-red-400 transition-colors">🔒 Lock</button>
          </div>
        </div>

        <div className="bg-gray-800 rounded-lg shadow overflow-x-auto">
          <table className="w-full text-left text-sm">
            <thead className="bg-gray-700">
              <tr><th className="p-3">Site</th><th className="p-3">Username</th><th className="p-3">Password</th><th className="p-3">Notes</th><th className="p-3">Actions</th></tr>
            </thead>
            <tbody>
              {filtered.length===0&&<tr><td colSpan="5" className="p-6 text-center text-gray-400">No records</td></tr>}
              {filtered.map(r=>(
                <tr key={r.id} className="border-t border-gray-700">
                  <td className="p-3">{r.site}</td>
                  <td className="p-3 mono">{r.username}</td>
                  <td className="p-3 mono">
                    {revealMap[r.id]?r.password:(r.password?"•".repeat(Math.min(12,r.password.length)):"")}
                    <div className="mt-1 flex gap-2">
                      <button onClick={()=>toggleReveal(r.id)} className="text-xs px-2 py-1 bg-gray-700 rounded flex items-center gap-1">{revealMap[r.id]?"🙈 Hide":"👁 Reveal"}</button>
                      <button onClick={()=>handleCopyPassword(r.password)} className="text-xs px-2 py-1 bg-gray-700 rounded flex items-center gap-1">📋 Copy</button>
                    </div>
                  </td>
                  <td className="p-3">{r.notes}</td>
                  <td className="p-3">
                    <div className="flex gap-2">
                      <button onClick={()=>startEdit(r)} className="px-2 py-1 bg-gray-700 rounded flex items-center gap-1 text-sm">✏️ Edit</button>
                      <button onClick={()=>removeRecord(r.id)} className="px-2 py-1 bg-red-600 hover:bg-red-500 rounded flex items-center gap-1 text-sm">🗑 Delete</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {editing&&(
          <div className="fixed inset-0 flex items-center justify-center bg-black/50">
            <div className="bg-gray-800 p-4 rounded-lg w-full max-w-md shadow">
              <h3 className="text-lg font-semibold mb-2">{database.find(x=>x.id===editing.id)?"Edit":"Add"} Record</h3>
              <input className="w-full mb-2 bg-gray-700 border border-gray-600 text-gray-100 rounded p-2" placeholder="Site" value={editing.site} onChange={e=>setEditing({...editing,site:e.target.value})}/>
              <input className="w-full mb-2 bg-gray-700 border border-gray-600 text-gray-100 rounded p-2" placeholder="Username" value={editing.username} onChange={e=>setEditing({...editing,username:e.target.value})}/>
              <input className="w-full mb-2 bg-gray-700 border border-gray-600 text-gray-100 rounded p-2" placeholder="Password" value={editing.password} onChange={e=>setEditing({...editing,password:e.target.value})}/>
              <textarea className="w-full mb-2 bg-gray-700 border border-gray-600 text-gray-100 rounded p-2" placeholder="Notes" value={editing.notes} onChange={e=>setEditing({...editing,notes:e.target.value})}/>
              <div className="flex gap-2 justify-end">
                <button onClick={()=>setEditing(null)} className="px-3 py-1 border border-gray-600 rounded">Cancel</button>
                <button onClick={()=>finishEdit(true)} className="px-3 py-1 bg-green-600 hover:bg-green-500 rounded">Save</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
