<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CredSaver_Web</title>
<link rel="manifest" href="manifest.json">


  <!-- Google Identity Services + React + Babel + Tailwind -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
  const CLIENT_ID = "505276830787-t7vk18o1tcssnk5195u301h99ev4627g.apps.googleusercontent.com";
  const SCOPES = "https://www.googleapis.com/auth/drive.file";
  const DRIVE_FILE_NAME = "CredSaver_Web.json";

  /* --- Crypto helpers --- */
  async function deriveKeyFromPassword(password, salt, iterations=190000){
    const enc = new TextEncoder();
    const pwKey = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations,hash:"SHA-256"},pwKey,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
  }
  function randomBytes(n){return crypto.getRandomValues(new Uint8Array(n));}
  async function encryptJSONWithPassword(obj,pw){
    const salt=randomBytes(16),iv=randomBytes(12);
    const key=await deriveKeyFromPassword(pw,salt);
    const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,new TextEncoder().encode(JSON.stringify(obj)));
    return {salt:[...salt],iv:[...iv],blob:[...new Uint8Array(ct)],iterations:190000,createdAt:new Date().toISOString()};
  }
  async function decryptBlobWithPassword(blob,pw){
    const salt=new Uint8Array(blob.salt),iv=new Uint8Array(blob.iv),ct=new Uint8Array(blob.blob);
    const key=await deriveKeyFromPassword(pw,salt,blob.iterations||190000);
    const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
    return JSON.parse(new TextDecoder().decode(pt));
  }

  /* --- Drive helpers --- */
  let accessToken=null, tokenClient=null;
  function requestAccessToken(setStatus){
    return new Promise(resolve=>{
      tokenClient=google.accounts.oauth2.initTokenClient({
        client_id:CLIENT_ID,scope:SCOPES,
        callback:resp=>{if(resp.access_token){accessToken=resp.access_token;setStatus("Connected");resolve(accessToken);}else{setStatus("Offline ❌");resolve(null);}}
      });
      setStatus("Requesting access...");
      try{tokenClient.requestAccessToken();}catch{setStatus("Offline ❌");resolve(null);}
      setTimeout(()=>{if(!accessToken)resolve(null);},20000);
    });
  }
  async function findDriveFile(){if(!accessToken)return null;
    const q=encodeURIComponent(`name='${DRIVE_FILE_NAME}' and trashed=false`);
    const res=await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,modifiedTime)`,{headers:{Authorization:"Bearer "+accessToken}});
    if(!res.ok)return null; const d=await res.json(); return d.files&&d.files[0]?d.files[0]:null;}
  async function createDriveFile(data){
    const meta={name:DRIVE_FILE_NAME,mimeType:"application/json"};
    const form=new FormData();
    form.append("metadata",new Blob([JSON.stringify(meta)],{type:"application/json"}));
    form.append("file",new Blob([JSON.stringify(data)],{type:"application/json"}));
    const r=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:"Bearer "+accessToken},body:form});
    if(!r.ok)return null;const j=await r.json();return j.id;
  }
  async function uploadToDrive(data,fileId,setStatus){
    if(!accessToken){await requestAccessToken(setStatus);if(!accessToken)return null;}
    if(!fileId){const f=await findDriveFile();fileId=f?f.id:null;}
    if(!fileId)fileId=await createDriveFile(data);
    if(!fileId)return null;
    setStatus("Syncing...");
    const form=new FormData();
    form.append("metadata",new Blob([JSON.stringify({})],{type:"application/json"}));
    form.append("file",new Blob([JSON.stringify(data)],{type:"application/json"}));
    const r=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`,
      {method:"PATCH",headers:{Authorization:"Bearer "+accessToken},body:form});
    if(!r.ok){console.error("Drive upload failed",r.status,await r.text());setStatus("Offline ❌");return null;}
    return fileId;
  }
  async function downloadFile(id){const r=await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`,{headers:{Authorization:"Bearer "+accessToken}});return r.ok?await r.json():null;}
  async function deleteFile(id){if(!id)return true;const r=await fetch(`https://www.googleapis.com/drive/v3/files/${id}`,{method:"DELETE",headers:{Authorization:"Bearer "+accessToken}});return r.ok;}

  /* --- React app --- */
  function App(){
    const [state,setState]=React.useState("idle");
    const [master,setMaster]=React.useState(""),[db,setDb]=React.useState([]),[editing,setEditing]=React.useState(null);
    const [reveal,setReveal]=React.useState({}),[status,setStatus]=React.useState("Not Connected"),[file,setFile]=React.useState(null),[googleReady,setGoogleReady]=React.useState(false);
    const [search,setSearch]=React.useState(""),[lastSync,setLastSync]=React.useState(null);

    async function persist(newDb){
      const enc=await encryptJSONWithPassword(newDb,master);
      const id=await uploadToDrive(enc,file?file.id:null,setStatus);
      if(id){setFile(await findDriveFile());setStatus("Synced ✅");setLastSync(new Date().toLocaleString());}
    }
    async function signIn(){setStatus("Auth...");const tok=await requestAccessToken(setStatus);if(!tok)return;
      const f=await findDriveFile();setFile(f);setGoogleReady(true);setState("locked");setStatus(f?"DB found":"No DB");}
    async function unlock(e){e&&e.preventDefault();if(!master)return;
      if(!file){const enc=await encryptJSONWithPassword([],master);const id=await uploadToDrive(enc,null,setStatus);if(!id)return;
        setFile(await findDriveFile());setDb([]);setState("unlocked");setStatus("Synced ✅");setLastSync(new Date().toLocaleString());return;}
      const blob=await downloadFile(file.id);if(!blob)return setStatus("Offline ❌");
      try{setDb(await decryptBlobWithPassword(blob,master));setState("unlocked");setStatus("Connected");}catch{alert("Wrong master password");}}
    function startAdd(){setEditing({id:Math.random().toString(36).slice(2),site:"",username:"",password:"",notes:"",updatedAt:new Date().toLocaleString()});}
    function startEdit(r){setEditing({...r});}
    function finishEdit(save){if(save&&editing){const e={...editing,updatedAt:new Date().toLocaleString()};setDb(p=>{const i=p.findIndex(x=>x.id===e.id);const u=i>=0?p.map(x=>x.id===e.id?e:x):[...p,e];persist(u);return u;});}setEditing(null);}
    function remove(id){if(!confirm("Delete?"))return;setDb(p=>{const u=p.filter(x=>x.id!==id);persist(u);return u;});}
    function toggle(id){setReveal(r=>({...r,[id]:!r[id]}));}
    async function copy(p){await navigator.clipboard.writeText(p);}
    function exportDb(){encryptJSONWithPassword(db,master).then(st=>{const blob=new Blob([JSON.stringify(st,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="CredSaver_Backup.json";a.click();URL.revokeObjectURL(url);});}

    // ✅ Updated Import function (merge, skip duplicates)
    async function importDb(ev){
      const f=ev.target.files[0]; if(!f) return;
      try {
        const txt=await f.text();
        const parsed=JSON.parse(txt);
        const pw=prompt("Password of backup:"); if(!pw) return;
        const imported=await decryptBlobWithPassword(parsed,pw);

        setDb(prev=>{
          const merged=[...prev];
          imported.forEach(rec=>{
            const dup=merged.find(x=>x.site===rec.site && x.username===rec.username);
            if(!dup){
              merged.push({...rec,updatedAt:new Date().toLocaleString()});
            }
          });
          persist(merged);
          alert("Import merged. "+(merged.length-prev.length)+" new records added.");
          return merged;
        });
      } catch(e){ alert("Import failed: "+(e.message||e)); }
      finally { ev.target.value=""; }
    }

    async function resetMaster(){const np=prompt("New master:");if(!np)return;const np2=prompt("Re-enter:");if(np!==np2)return alert("Mismatch");const enc=await encryptJSONWithPassword(db,np);const id=await uploadToDrive(enc,file?file.id:null,setStatus);if(id){setMaster(np);setFile(await findDriveFile());setStatus("Synced ✅");setLastSync(new Date().toLocaleString());}}
    async function delDb(){if(!confirm("Delete DB from Drive?"))return;const ok=await deleteFile(file?file.id:null);if(ok){setDb([]);setFile(null);setGoogleReady(false);setState("idle");setStatus("Deleted");}}

    const filtered=db.filter(r=>{const q=search.toLowerCase();return !q||(r.site||"").toLowerCase().includes(q)||(r.username||"").toLowerCase().includes(q)||(r.notes||"").toLowerCase().includes(q);});

    if(state==="idle"||state==="locked")return(
      <div className="min-h-screen flex items-center justify-center p-6">
        <div className="w-full max-w-md bg-gray-800 rounded-2xl shadow p-6">
          <h1 className="text-2xl mb-2">CredSaver_Web</h1>
          <button onClick={signIn} className="w-full px-4 py-2 bg-indigo-600 mb-3 rounded">Sign in with Google</button>
          <input disabled={!googleReady} type="password" value={master} onChange={e=>setMaster(e.target.value)} placeholder="Master password" className="w-full mb-2 bg-gray-700 rounded p-2"/>
          <button onClick={unlock} disabled={!googleReady} className="w-full px-4 py-2 bg-blue-600 rounded">Unlock / Create</button>
          <p className="mt-3 text-xs">Drive: {status}{lastSync&&` (Last sync: ${lastSync})`}</p>
        </div>
      </div>);
    return(
      <div className="p-6">
        <div className="max-w-5xl mx-auto mb-4">
          <div className="flex justify-between mb-3">
            <h1 className="text-2xl">CredSaver_Web</h1>
            <input className="bg-gray-700 rounded p-2 w-64" placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)}/>
          </div>
          <div className="flex flex-wrap gap-2 mb-4">
            <button onClick={startAdd} className="px-3 py-2 bg-green-600 rounded">➕ Add</button>
            <button onClick={exportDb} className="px-3 py-2 bg-gray-700 rounded">📤 Export</button>
            <label className="px-3 py-2 bg-gray-700 rounded cursor-pointer">📥 Import<input type="file" className="hidden" accept=".json" onChange={importDb}/></label>
            <button onClick={resetMaster} className="px-3 py-2 bg-amber-600 rounded">🔑 Reset Master</button>
            <button onClick={delDb} className="px-3 py-2 bg-red-600 rounded">🗑 Delete DB</button>
            <span className="ml-4 text-sm">Drive: {status}{lastSync&&` (Last sync: ${lastSync})`}</span>
            <button onClick={()=>setState("locked")} className="ml-auto px-3 py-2 border rounded">🔒 Lock</button>
          </div>
        </div>
        <div className="max-w-5xl mx-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-700"><tr><th className="p-3">Site</th><th className="p-3">Username</th><th className="p-3">Password</th><th className="p-3">Notes</th><th className="p-3">Last Updated</th><th className="p-3">Actions</th></tr></thead>
            <tbody>{filtered.length===0&&<tr><td colSpan="6" className="p-6 text-center text-gray-400">No records</td></tr>}
              {filtered.map(r=><tr key={r.id} className="border-t border-gray-700">
                <td className="p-3">{r.site}</td>
                <td className="p-3 mono">{r.username}</td>
                <td className="p-3 mono">{reveal[r.id]?r.password:(r.password?"•".repeat(Math.min(12,r.password.length)):"")}
                  <div className="mt-1 flex gap-2"><button onClick={()=>toggle(r.id)} className="text-xs bg-gray-700 px-2 py-1 rounded">{reveal[r.id]?"🙈":"👁"}</button><button onClick={()=>copy(r.password)} className="text-xs bg-gray-700 px-2 py-1 rounded">📋</button></div></td>
                <td className="p-3">{r.notes}</td>
                <td className="p-3 text-xs text-gray-400">{r.updatedAt||""}</td>
                <td className="p-3 flex gap-2"><button onClick={()=>startEdit(r)} className="px-2 py-1 bg-gray-700 rounded">✏️</button><button onClick={()=>remove(r.id)} className="px-2 py-1 bg-red-600 rounded">🗑</button></td>
              </tr>)}
            </tbody>
          </table>
        </div>
        {editing&&<div className="fixed inset-0 flex items-center justify-center bg-black/50"><div className="bg-gray-800 p-4 rounded-lg w-full max-w-md">
          <h3 className="text-lg mb-2">{db.find(x=>x.id===editing.id)?"Edit":"Add"} Record</h3>
          <input className="w-full mb-2 bg-gray-700 rounded p-2" placeholder="Site" value={editing.site} onChange={e=>setEditing({...editing,site:e.target.value})}/>
          <input className="w-full mb-2 bg-gray-700 rounded p-2" placeholder="Username" value={editing.username} onChange={e=>setEditing({...editing,username:e.target.value})}/>
          <input className="w-full mb-2 bg-gray-700 rounded p-2" placeholder="Password" value={editing.password} onChange={e=>setEditing({...editing,password:e.target.value})}/>
          <textarea className="w-full mb-2 bg-gray-700 rounded p-2" placeholder="Notes" value={editing.notes} onChange={e=>setEditing({...editing,notes:e.target.value})}/>
          <div className="flex justify-end gap-2"><button onClick={()=>setEditing(null)} className="px-3 py-1 border rounded">Cancel</button><button onClick={()=>finishEdit(true)} className="px-3 py-1 bg-green-600 rounded">Save</button></div>
        </div></div>}
      </div>);
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
	
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker
        .register("/service-worker.js")
        .then(reg => console.log("Service Worker registered:", reg))
        .catch(err => console.error("Service Worker registration failed:", err));
    });
  }
</script>


</body>
</html>
